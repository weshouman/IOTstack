
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Docker stack for getting started on IOT on the Raspberry PI">
      
      
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.1.2, mkdocs-material-7.1.1">
    
    
      
        <title>Build Stack Random Services Password - IOTstack</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.9299cb39.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.ef6f36e2.min.css">
        
      
    
    
    
      
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>:root{--md-text-font-family:"Roboto";--md-code-font-family:"Roboto Mono"}</style>
      
    
    
    
    
      
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="none" data-md-color-accent="none">
  
    
    <script>function __prefix(e){return new URL("..",location).pathname+"."+e}function __get(e,t=localStorage){return JSON.parse(t.getItem(__prefix(e)))}</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#build-stack-random-services-password" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="IOTstack" class="md-header__button md-logo" aria-label="IOTstack" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            IOTstack
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Build Stack Random Services Password
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" data-md-state="active" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="IOTstack" class="md-nav__button md-logo" aria-label="IOTstack" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg>

    </a>
    IOTstack
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        IOTStack Wiki
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../Accessing-your-Device-from-the-internet/" class="md-nav__link">
        Accessing your device from the internet
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../Backup-and-Restore/" class="md-nav__link">
        Backing up and restoring IOTstack
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Build Stack Random Services Password
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Build Stack Random Services Password
      </a>
      
        
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#a-word-of-caution" class="md-nav__link">
    A word of caution
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#a-basic-example" class="md-nav__link">
    A basic example
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#code-commonly-used-to-update-passwords" class="md-nav__link">
    Code commonly used to update passwords
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#code-for-your-services-menu" class="md-nav__link">
    Code for your service's menu
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#password-settings-screen" class="md-nav__link">
    Password settings screen
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../BuildStack-Services/" class="md-nav__link">
        Build Stack Services system
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../Contributing-Services/" class="md-nav__link">
        Contributing a service to IOTstack
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../Custom/" class="md-nav__link">
        Custom services and overriding default settings for IOTstack
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../Default-Configs/" class="md-nav__link">
        Build Stack Default Passwords for Services
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../Docker-commands/" class="md-nav__link">
        Docker commands
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../Getting-Started/" class="md-nav__link">
        Getting Started
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../Home/" class="md-nav__link">
        Wiki
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../How-the-script-works/" class="md-nav__link">
        How the script works
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../Menu-System/" class="md-nav__link">
        Menu system
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../Misc/" class="md-nav__link">
        Miscellaneous
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../Native-RTL_433/" class="md-nav__link">
        Native RTL_433
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../Networking/" class="md-nav__link">
        Networking
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../New-Menu-Release-Notes/" class="md-nav__link">
        New IOTstack Menu
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../PostBuild-Script/" class="md-nav__link">
        Postbuild BASH Script
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../RPIEasy_native/" class="md-nav__link">
        RPIEasy
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../Understanding-Containers/" class="md-nav__link">
        What is Docker?
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../Updating-the-Project/" class="md-nav__link">
        Updating the project
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../gcgarner-migration/" class="md-nav__link">
        Migrating from gcgarner to SensorsIot
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_23" type="checkbox" id="__nav_23" >
      
      <label class="md-nav__link" for="__nav_23">
        Containers
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Containers" data-md-level="1">
        <label class="md-nav__title" for="__nav_23">
          <span class="md-nav__icon md-icon"></span>
          Containers
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../Containers/Adminer/" class="md-nav__link">
        Adminer
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../Containers/Blynk_server/" class="md-nav__link">
        Blynk server
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../Containers/DashMachine/" class="md-nav__link">
        DashMachine
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../Containers/EspruinoHub/" class="md-nav__link">
        Espruinohub
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../Containers/Grafana/" class="md-nav__link">
        Grafana
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../Containers/Heimdall/" class="md-nav__link">
        Heimdall
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../Containers/Home-Assistant/" class="md-nav__link">
        Home assistant
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../Containers/Homer/" class="md-nav__link">
        Homer
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../Containers/InfluxDB/" class="md-nav__link">
        InfluxDB
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../Containers/MariaDB/" class="md-nav__link">
        MariaDB
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../Containers/Mosquitto/" class="md-nav__link">
        Mosquitto
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../Containers/MotionEye/" class="md-nav__link">
        MotionEye
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../Containers/NextCloud/" class="md-nav__link">
        Next Cloud
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../Containers/Node-RED/" class="md-nav__link">
        Node-RED
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../Containers/Pi-hole/" class="md-nav__link">
        Pi-hole
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../Containers/Plex/" class="md-nav__link">
        Plex
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../Containers/Portainer-agent/" class="md-nav__link">
        Portainer agent
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../Containers/Portainer-ce/" class="md-nav__link">
        Portainer CE
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../Containers/Portainer/" class="md-nav__link">
        Portainer
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../Containers/PostgreSQL/" class="md-nav__link">
        PostgreSQL
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../Containers/Python/" class="md-nav__link">
        Python
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../Containers/RTL_433-docker/" class="md-nav__link">
        RTL_433 Docker
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../Containers/TasmoAdmin/" class="md-nav__link">
        TasmoAdmin
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../Containers/WireGuard/" class="md-nav__link">
        WireGuard
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../Containers/Zigbee2MQTT/" class="md-nav__link">
        Zigbee2MQTT
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../Containers/Zigbee2mqttassistant/" class="md-nav__link">
        Zigbee2Mqtt Assistant
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../Containers/deconz/" class="md-nav__link">
        deCONZ
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../Containers/diyHue/" class="md-nav__link">
        DIY hue
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../Containers/openHAB/" class="md-nav__link">
        Openhab
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../Containers/x2go/" class="md-nav__link">
        x2go
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#a-word-of-caution" class="md-nav__link">
    A word of caution
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#a-basic-example" class="md-nav__link">
    A basic example
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#code-commonly-used-to-update-passwords" class="md-nav__link">
    Code commonly used to update passwords
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#code-for-your-services-menu" class="md-nav__link">
    Code for your service's menu
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#password-settings-screen" class="md-nav__link">
    Password settings screen
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                
                
                <h1 id="build-stack-random-services-password">Build Stack Random Services Password</h1>
<p>This page explains how to have a service generate a random password during build time. This will require that your service have a working options menu.</p>
<p>Keep in mind that updating strings in a service's yaml config isn't limited to passwords.</p>
<h2 id="a-word-of-caution">A word of caution</h2>
<p>Many services often set a password on their initial spin up and store it internally. That means if if the password is changed by the menu afterwards, it may not be reflected in the service. By default the password specified in the documentation should be used, unless the user specifically selected to use a randomly generated one. In the future, the feature to specify a password manually may be added in, much like how ports can be customised.</p>
<h2 id="a-basic-example">A basic example</h2>
<p>Inside the service's <code>service.yml</code> file, a special string can be added in for the build script to find and replace. Commonly the string is <code>%randomPassword%</code>, but technically any string can be used. The same string can be used multiple times for the same password to be used multiple times, and/or multiple difference strings can be used for multiple passwords.</p>
<pre><code>  mariadb:
    image: linuxserver/mariadb
    container_name: mariadb
    environment:
      - MYSQL_ROOT_PASSWORD=%randomAdminPassword%
      - MYSQL_DATABASE=default
      - MYSQL_USER=mariadbuser
      - MYSQL_PASSWORD=%randomPassword%
</code></pre>
<p>These strings will be updated during the Prebuild Hook stage when building. The code to make this happen is shown below.</p>
<h2 id="code-commonly-used-to-update-passwords">Code commonly used to update passwords</h2>
<p>This code can basically be copy-pasted into your service's <code>build.py</code> file. You are welcome to expand upon it if required. It will probably be refactored into a utils function in the future to adear to DRY (Don't Repeat Yourself) practices.</p>
<pre><code>def preBuild():
  # Multi-service load. Most services only include a single service. The exception being NextCloud where the database information needs to match between NextCloud and MariaDB (as defined in NextCloud's 'service.yml' file, not IOTstack's MariaDB).
  with open((r'%s/' % serviceTemplate) + servicesFileName) as objServiceFile:
    serviceYamlTemplate = yaml.load(objServiceFile)

  oldBuildCache = {}
  try:
    with open(r'%s' % buildCache) as objBuildCache: # Load previous build, if it exists
      oldBuildCache = yaml.load(objBuildCache)
  except:
    pass

  buildCacheServices = {}
  if &quot;services&quot; in oldBuildCache: # If a previous build does exist, load it so that we can reuse the password from it if required.
    buildCacheServices = oldBuildCache[&quot;services&quot;]

  if not os.path.exists(serviceService): # Create the service directory for the service
    os.makedirs(serviceService, exist_ok=True)

  # Check if buildSettings file exists (from previous build), or create one if it doesn't (in the else block).
  if os.path.exists(buildSettings):
    # Password randomisation
    with open(r'%s' % buildSettings) as objBuildSettingsFile:
      piHoleYamlBuildOptions = yaml.load(objBuildSettingsFile)
      if (
        piHoleYamlBuildOptions[&quot;databasePasswordOption&quot;] == &quot;Randomise database password for this build&quot;
        or piHoleYamlBuildOptions[&quot;databasePasswordOption&quot;] == &quot;Randomise database password every build&quot;
        or deconzYamlBuildOptions[&quot;databasePasswordOption&quot;] == &quot;Use default password for this build&quot;
      ):

        if deconzYamlBuildOptions[&quot;databasePasswordOption&quot;] == &quot;Use default password for this build&quot;:
          newAdminPassword = &quot;######&quot; # Update to what's specified in your documentation
          newPassword = &quot;######&quot; # Update to what's specified in your documentation
        else:
          # Generate our passwords
          newAdminPassword = generateRandomString()
          newPassword = generateRandomString()

        # Here we loop through each service included in the current service's `service.yml` file and update the password strings.
        for (index, serviceName) in enumerate(serviceYamlTemplate):
          dockerComposeServicesYaml[serviceName] = serviceYamlTemplate[serviceName]
          if &quot;environment&quot; in serviceYamlTemplate[serviceName]:
            for (envIndex, envName) in enumerate(serviceYamlTemplate[serviceName][&quot;environment&quot;]):
              envName = envName.replace(&quot;%randomPassword%&quot;, newPassword)
              envName = envName.replace(&quot;%randomAdminPassword%&quot;, newAdminPassword)
              dockerComposeServicesYaml[serviceName][&quot;environment&quot;][envIndex] = envName

        # If the user had selected to only update the password once, ensure the build options file is updated.
        if (piHoleYamlBuildOptions[&quot;databasePasswordOption&quot;] == &quot;Randomise database password for this build&quot;):
          piHoleYamlBuildOptions[&quot;databasePasswordOption&quot;] = &quot;Do nothing&quot;
          with open(buildSettings, 'w') as outputFile:
            yaml.dump(piHoleYamlBuildOptions, outputFile)
      else: # Do nothing - don't change password
        for (index, serviceName) in enumerate(buildCacheServices):
          if serviceName in buildCacheServices: # Load service from cache if exists (to maintain password)
            dockerComposeServicesYaml[serviceName] = buildCacheServices[serviceName]
          else:
            dockerComposeServicesYaml[serviceName] = serviceYamlTemplate[serviceName]

  # Build options file didn't exist, so create one, and also use default password (default action).
  else:
    print(&quot;PiHole Warning: Build settings file not found, using default password&quot;)
    time.sleep(1)
    newAdminPassword = &quot;######&quot; # Update to what's specified in your documentation
    newPassword = &quot;######&quot; # Update to what's specified in your documentation
    for (index, serviceName) in enumerate(serviceYamlTemplate):
      dockerComposeServicesYaml[serviceName] = serviceYamlTemplate[serviceName]
      if &quot;environment&quot; in serviceYamlTemplate[serviceName]:
        for (envIndex, envName) in enumerate(serviceYamlTemplate[serviceName][&quot;environment&quot;]):
          envName = envName.replace(&quot;%randomPassword%&quot;, newPassword)
          envName = envName.replace(&quot;%randomAdminPassword%&quot;, newAdminPassword)
          dockerComposeServicesYaml[serviceName][&quot;environment&quot;][envIndex] = envName
      piHoleYamlBuildOptions = {
        &quot;version&quot;: &quot;1&quot;,
        &quot;application&quot;: &quot;IOTstack&quot;,
        &quot;service&quot;: &quot;PiHole&quot;,
        &quot;comment&quot;: &quot;PiHole Build Options&quot;
      }

    piHoleYamlBuildOptions[&quot;databasePasswordOption&quot;] = &quot;Do nothing&quot;
    with open(buildSettings, 'w') as outputFile:
      yaml.dump(piHoleYamlBuildOptions, outputFile)

  return True
</code></pre>
<h2 id="code-for-your-services-menu">Code for your service's menu</h2>
<p>While not needed, since the default action is to create a random password, it is a good idea to allow the user to choose what to do. This can be achieved by giving them access to a password menu. This code can be placed in your service's <code>build.py</code> file, that will show a new menu option, allowing users to select it and be taken to a password settings screen.</p>
<p>Remember that you need to have an already working menu, and to place this code into it.</p>
<pre><code>import signal

...

def setPasswordOptions():
  global needsRender
  global hasRebuiltAddons
  passwordOptionsMenuFilePath = &quot;./.templates/{currentService}/passwords.py&quot;.format(currentService=currentServiceName)
  with open(passwordOptionsMenuFilePath, &quot;rb&quot;) as pythonDynamicImportFile:
    code = compile(pythonDynamicImportFile.read(), passwordOptionsMenuFilePath, &quot;exec&quot;)
  execGlobals = {
    &quot;currentServiceName&quot;: currentServiceName,
    &quot;renderMode&quot;: renderMode
  }
  execLocals = {}
  screenActive = False
  exec(code, execGlobals, execLocals)
  signal.signal(signal.SIGWINCH, onResize)
  screenActive = True
  needsRender = 1

...

def createMenu():
  global yourServicesBuildOptions
  global serviceService

  yourServicesBuildOptions = []
  yourServicesBuildOptions.append([
    &quot;Your Service Password Options&quot;,
    setPasswordOptions
  ])

  yourServicesBuildOptions.append([&quot;Go back&quot;, goBack])

</code></pre>
<h2 id="password-settings-screen">Password settings screen</h2>
<p>The code for the Password settings is lengthy, but it's pasted here for convienence</p>
<pre><code>#!/usr/bin/env python3

import signal

def main():
  from blessed import Terminal
  from deps.chars import specialChars, commonTopBorder, commonBottomBorder, commonEmptyLine
  from deps.consts import servicesDirectory, templatesDirectory, buildSettingsFileName
  import time
  import subprocess
  import ruamel.yamls
  import os

  global signal
  global currentServiceName
  global menuSelectionInProgress
  global mainMenuList
  global currentMenuItemIndex
  global renderMode
  global paginationSize
  global paginationStartIndex
  global hideHelpText

  yaml = ruamel.yaml.YAML()
  yaml.preserve_quotes = True

  try: # If not already set, then set it.
    hideHelpText = hideHelpText
  except:
    hideHelpText = False

  term = Terminal()
  hotzoneLocation = [((term.height // 16) + 6), 0]
  paginationToggle = [10, term.height - 25]
  paginationStartIndex = 0
  paginationSize = paginationToggle[0]

  serviceService = servicesDirectory + currentServiceName
  serviceTemplate = templatesDirectory + currentServiceName
  buildSettings = serviceService + buildSettingsFileName

  def goBack():
    global menuSelectionInProgress
    global needsRender
    menuSelectionInProgress = False
    needsRender = 1
    return True

  mainMenuList = []

  hotzoneLocation = [((term.height // 16) + 6), 0]

  menuSelectionInProgress = True
  currentMenuItemIndex = 0
  menuNavigateDirection = 0

  # Render Modes:
  #  0 = No render needed
  #  1 = Full render
  #  2 = Hotzone only
  needsRender = 1

  def onResize(sig, action):
    global mainMenuList
    global currentMenuItemIndex
    mainRender(1, mainMenuList, currentMenuItemIndex)

  def generateLineText(text, textLength=None, paddingBefore=0, lineLength=64):
    result = &quot;&quot;
    for i in range(paddingBefore):
      result += &quot; &quot;

    textPrintableCharactersLength = textLength

    if (textPrintableCharactersLength) == None:
      textPrintableCharactersLength = len(text)

    result += text
    remainingSpace = lineLength - textPrintableCharactersLength

    for i in range(remainingSpace):
      result += &quot; &quot;

    return result

  def renderHotZone(term, renderType, menu, selection, hotzoneLocation, paddingBefore = 4):
    global paginationSize
    selectedTextLength = len(&quot;-&gt; &quot;)

    print(term.move(hotzoneLocation[0], hotzoneLocation[1]))

    if paginationStartIndex &gt;= 1:
      print(term.center(&quot;{b}       {uaf}      {uaf}{uaf}{uaf}                                                   {ual}           {b}&quot;.format(
        b=specialChars[renderMode][&quot;borderVertical&quot;],
        uaf=specialChars[renderMode][&quot;upArrowFull&quot;],
        ual=specialChars[renderMode][&quot;upArrowLine&quot;]
      )))
    else:
      print(term.center(commonEmptyLine(renderMode)))

    for (index, menuItem) in enumerate(menu): # Menu loop
      if index &gt;= paginationStartIndex and index &lt; paginationStartIndex + paginationSize:
        lineText = generateLineText(menuItem[0], paddingBefore=paddingBefore)

        # Menu highlight logic
        if index == selection:
          formattedLineText = '-&gt; {t.blue_on_green}{title}{t.normal} &lt;-'.format(t=term, title=menuItem[0])
          paddedLineText = generateLineText(formattedLineText, textLength=len(menuItem[0]) + selectedTextLength, paddingBefore=paddingBefore - selectedTextLength)
          toPrint = paddedLineText
        else:
          toPrint = '{title}{t.normal}'.format(t=term, title=lineText)
        # #####

        # Menu check render logic
        if menuItem[1][&quot;checked&quot;]:
          toPrint = &quot;     (X) &quot; + toPrint
        else:
          toPrint = &quot;     ( ) &quot; + toPrint

        toPrint = &quot;{bv} {toPrint}  {bv}&quot;.format(bv=specialChars[renderMode][&quot;borderVertical&quot;], toPrint=toPrint) # Generate border
        toPrint = term.center(toPrint) # Center Text (All lines should have the same amount of printable characters)
        # #####
        print(toPrint)

    if paginationStartIndex + paginationSize &lt; len(menu):
      print(term.center(&quot;{b}       {daf}      {daf}{daf}{daf}                                                   {dal}           {b}&quot;.format(
        b=specialChars[renderMode][&quot;borderVertical&quot;],
        daf=specialChars[renderMode][&quot;downArrowFull&quot;],
        dal=specialChars[renderMode][&quot;downArrowLine&quot;]
      )))
    else:
      print(term.center(commonEmptyLine(renderMode)))
    print(term.center(commonEmptyLine(renderMode)))
    print(term.center(commonEmptyLine(renderMode)))


  def mainRender(needsRender, menu, selection):
    global paginationStartIndex
    global paginationSize
    term = Terminal()

    if selection &gt;= paginationStartIndex + paginationSize:
      paginationStartIndex = selection - (paginationSize - 1) + 1
      needsRender = 1

    if selection &lt;= paginationStartIndex - 1:
      paginationStartIndex = selection
      needsRender = 1

    if needsRender == 1:
      print(term.clear())
      print(term.move_y(term.height // 16))
      print(term.black_on_cornsilk4(term.center('IOTstack YourServices Password Options')))
      print(&quot;&quot;)
      print(term.center(commonTopBorder(renderMode)))
      print(term.center(commonEmptyLine(renderMode)))
      print(term.center(&quot;{bv}      Select Password Option                                                    {bv}&quot;.format(bv=specialChars[renderMode][&quot;borderVertical&quot;])))
      print(term.center(commonEmptyLine(renderMode)))

    if needsRender &gt;= 1:
      renderHotZone(term, needsRender, menu, selection, hotzoneLocation)

    if needsRender == 1:
      print(term.center(commonEmptyLine(renderMode)))
      if not hideHelpText:
        if term.height &lt; 32:
          print(term.center(commonEmptyLine(renderMode)))
          print(term.center(&quot;{bv}      Not enough vertical room to render controls help text                     {bv}&quot;.format(bv=specialChars[renderMode][&quot;borderVertical&quot;])))
          print(term.center(commonEmptyLine(renderMode)))
        else: 
          print(term.center(commonEmptyLine(renderMode)))
          print(term.center(&quot;{bv}      Controls:                                                                 {bv}&quot;.format(bv=specialChars[renderMode][&quot;borderVertical&quot;])))
          print(term.center(&quot;{bv}      [Space] to select option                                                  {bv}&quot;.format(bv=specialChars[renderMode][&quot;borderVertical&quot;])))
          print(term.center(&quot;{bv}      [Up] and [Down] to move selection cursor                                  {bv}&quot;.format(bv=specialChars[renderMode][&quot;borderVertical&quot;])))
          print(term.center(&quot;{bv}      [H] Show/hide this text                                                   {bv}&quot;.format(bv=specialChars[renderMode][&quot;borderVertical&quot;])))
          print(term.center(&quot;{bv}      [Enter] to build and save option                                          {bv}&quot;.format(bv=specialChars[renderMode][&quot;borderVertical&quot;])))
          print(term.center(&quot;{bv}      [Escape] to cancel changes                                                {bv}&quot;.format(bv=specialChars[renderMode][&quot;borderVertical&quot;])))
          print(term.center(commonEmptyLine(renderMode)))
          print(term.center(commonEmptyLine(renderMode)))
      print(term.center(commonBottomBorder(renderMode)))

  def runSelection(selection):
    import types
    if len(mainMenuList[selection]) &gt; 1 and isinstance(mainMenuList[selection][1], types.FunctionType):
      mainMenuList[selection][1]()
    else:
      print(term.green_reverse('IOTstack Error: No function assigned to menu item: &quot;{}&quot;'.format(mainMenuList[selection][0])))

  def isMenuItemSelectable(menu, index):
    if len(menu) &gt; index:
      if len(menu[index]) &gt; 1:
        if &quot;skip&quot; in menu[index][1] and menu[index][1][&quot;skip&quot;] == True:
          return False
    return True

  def loadOptionsMenu():
    global mainMenuList
    mainMenuList.append([&quot;Use default password for this build&quot;, { &quot;checked&quot;: True }])
    mainMenuList.append([&quot;Randomise database password for this build&quot;, { &quot;checked&quot;: False }])
    mainMenuList.append([&quot;Randomise database password every build&quot;, { &quot;checked&quot;: False }])
    mainMenuList.append([&quot;Do nothing&quot;, { &quot;checked&quot;: False }])

  def checkMenuItem(selection):
    global mainMenuList
    for (index, menuItem) in enumerate(mainMenuList):
      mainMenuList[index][1][&quot;checked&quot;] = False

    mainMenuList[selection][1][&quot;checked&quot;] = True

  def saveOptions():
    try:
      if not os.path.exists(serviceService):
        os.makedirs(serviceService, exist_ok=True)

      if os.path.exists(buildSettings):
        with open(r'%s' % buildSettings) as objBuildSettingsFile:
          yourServicesYamlBuildOptions = yaml.load(objBuildSettingsFile)
      else:
        yourServices = {
          &quot;version&quot;: &quot;1&quot;,
          &quot;application&quot;: &quot;IOTstack&quot;,
          &quot;service&quot;: &quot;Your Service&quot;,
          &quot;comment&quot;: &quot;Your Service Build Options&quot;
        }

      yourServices[&quot;databasePasswordOption&quot;] = &quot;&quot;

      for (index, menuOption) in enumerate(mainMenuList):
        if menuOption[1][&quot;checked&quot;]:
          yourServices[&quot;databasePasswordOption&quot;] = menuOption[0]
          break

      with open(buildSettings, 'w') as outputFile:
        yaml.dump(yourServices, outputFile)

    except Exception as err: 
      print(&quot;Error saving Your Services Password options&quot;, currentServiceName)
      print(err)
      return False
    global hasRebuiltHardwareSelection
    hasRebuiltHardwareSelection = True
    return True

  def loadOptions():
    try:
      if not os.path.exists(serviceService):
        os.makedirs(serviceService, exist_ok=True)

      if os.path.exists(buildSettings):
        with open(r'%s' % buildSettings) as objBuildSettingsFile:
          yourServicesYamlBuildOptions = yaml.load(objBuildSettingsFile)

        for (index, menuOption) in enumerate(mainMenuList):
          if menuOption[0] == yourServicesYamlBuildOptions[&quot;databasePasswordOption&quot;]:
            checkMenuItem(index)
            break

    except Exception as err: 
      print(&quot;Error loading Your Services Password options&quot;, currentServiceName)
      print(err)
      return False
    return True


  if __name__ == 'builtins':
    global signal
    term = Terminal()
    signal.signal(signal.SIGWINCH, onResize)
    loadOptionsMenu()
    loadOptions()
    with term.fullscreen():
      menuNavigateDirection = 0
      mainRender(needsRender, mainMenuList, currentMenuItemIndex)
      menuSelectionInProgress = True
      with term.cbreak():
        while menuSelectionInProgress:
          menuNavigateDirection = 0

          if not needsRender == 0: # Only rerender when changed to prevent flickering
            mainRender(needsRender, mainMenuList, currentMenuItemIndex)
            needsRender = 0

          key = term.inkey(esc_delay=0.05)
          if key.is_sequence:
            if key.name == 'KEY_TAB':
              if paginationSize == paginationToggle[0]:
                paginationSize = paginationToggle[1]
              else:
                paginationSize = paginationToggle[0]
              mainRender(1, mainMenuList, currentMenuItemIndex)
            if key.name == 'KEY_DOWN':
              menuNavigateDirection += 1
            if key.name == 'KEY_UP':
              menuNavigateDirection -= 1
            if key.name == 'KEY_ENTER':
              if saveOptions():
                return True
              else:
                print(&quot;Something went wrong. Try saving the list again.&quot;)
            if key.name == 'KEY_ESCAPE':
              menuSelectionInProgress = False
              return True
          elif key:
            if key == ' ': # Space pressed
              checkMenuItem(currentMenuItemIndex) # Update checked list
              needsRender = 2
            elif key == 'h': # H pressed
              if hideHelpText:
                hideHelpText = False
              else:
                hideHelpText = True
              mainRender(1, mainMenuList, currentMenuItemIndex)

          if menuNavigateDirection != 0: # If a direction was pressed, find next selectable item
            currentMenuItemIndex += menuNavigateDirection
            currentMenuItemIndex = currentMenuItemIndex % len(mainMenuList)
            needsRender = 2

            while not isMenuItemSelectable(mainMenuList, currentMenuItemIndex):
              currentMenuItemIndex += menuNavigateDirection
              currentMenuItemIndex = currentMenuItemIndex % len(mainMenuList)
    return True

  return True

originalSignalHandler = signal.getsignal(signal.SIGINT)
main()
signal.signal(signal.SIGWINCH, originalSignalHandler)

</code></pre>
                
              
              
                


              
            </article>
          </div>
        </div>
        
      </main>
      
        
<footer class="md-footer">
  
    <nav class="md-footer__inner md-grid" aria-label="Footer">
      
        <a href="../Backup-and-Restore/" class="md-footer__link md-footer__link--prev" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              Backing up and restoring IOTstack
            </div>
          </div>
        </a>
      
      
        <a href="../BuildStack-Services/" class="md-footer__link md-footer__link--next" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Next
              </span>
              Build Stack Services system
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
        
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "..", "features": ["tabs"], "translations": {"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing"}, "search": "../assets/javascripts/workers/search.fe42c31b.min.js", "version": null}</script>
    
    
      <script src="../assets/javascripts/bundle.7353b375.min.js"></script>
      
    
  </body>
</html>